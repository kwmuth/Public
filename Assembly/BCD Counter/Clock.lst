0000              1   ; Blinky_Int.asm: blinks LEDR0 of the DE2-8052 each second.
0000              2   ; Also generates a 2kHz signal at P0.0 using timer 0 interrupt.
0000              3   ; Also keeps a BCD counter using timer 2 interrupt.
0000              4   
                 -1   $MODDE2
0000              1   ;  MODDDE2: Register definition for DE2-8052 softcore
0000              2   ;
0000              3   ;   Copyright (C) 2011  Jesus Calvino-Fraga, jesusc at ece.ubc.ca
0000              4   ;
0000              5   ;   This library is free software; you can redistribute it and/or
0000              6   ;   modify it under the terms of the GNU Lesser General Public
0000              7   ;   License as published by the Free Software Foundation; either
0000              8   ;   version 2.1 of the License, or (at your option) any later version.
0000              9   ;
0000             10   ;   This library is distributed in the hope that it will be useful,
0000             11   ;   but WITHOUT ANY WARRANTY; without even the implied warranty of
0000             12   ;   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
0000             13   ;   Lesser General Public License for more details.
0000             14   ;
0000             15   ;   You should have received a copy of the GNU Lesser General Public
0000             16   ;   License along with this library; if not, write to the Free Software
0000             17   ;   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA
0000             18   ;
0000             19       
0000             20   P0     DATA  080H  ;PORT 0
0000             21   SP     DATA  081H  ;STACK POINTER
0000             22   DPL    DATA  082H  ;DATA POINTER - LOW BYTE
0000             23   DPH    DATA  083H  ;DATA POINTER - HIGH BYTE
0000             24   PCON   DATA  087H  ;POWER CONTROL
0000             25   TCON   DATA  088H  ;TIMER CONTROL
0000             26   TMOD   DATA  089H  ;TIMER MODE
0000             27   TL0    DATA  08AH  ;TIMER 0 - LOW BYTE
0000             28   TL1    DATA  08BH  ;TIMER 1 - LOW BYTE
0000             29   TH0    DATA  08CH  ;TIMER 0 - HIGH BYTE
0000             30   TH1    DATA  08DH  ;TIMER 1 - HIGH BYTE
0000             31   P1     DATA  090H  ;PORT 1
0000             32   SCON   DATA  098H  ;SERIAL PORT CONTROL
0000             33   SBUF   DATA  099H  ;SERIAL PORT BUFFER
0000             34   P2     DATA  0A0H  ;PORT 2
0000             35   IE     DATA  0A8H  ;INTERRUPT ENABLE
0000             36   P3     DATA  0B0H  ;PORT 3
0000             37   IP     DATA  0B8H  ;INTERRUPT PRIORITY
0000             38   T2CON  DATA  0C8H  ;TIMER 2 CONTROL
0000             39   T2MOD  DATA  0C9H  ;TIMER 2 MODE
0000             40   RCAP2L DATA  0CAH  ;TIMER 2 CAPTURE REGISTER - LOW BYTE
0000             41   RCAP2H DATA  0CBH  ;TIMER 2 CAPTURE REGISTER - HIGH BYTE
0000             42   TL2    DATA  0CCH  ;TIMER 2 - LOW BYTE
0000             43   TH2    DATA  0CDH  ;TIMER 2 - HIGH BYTE
0000             44   PSW    DATA  0D0H  ;PROGRAM STATUS WORD
0000             45   ACC    DATA  0E0H  ;ACCUMULATOR
0000             46   B      DATA  0F0H  ;MULTIPLICATION REGISTER
0000             47   IT0    BIT   088H  ;TCON.0 - EXT. INTERRUPT 0 TYPE
0000             48   IE0    BIT   089H  ;TCON.1 - EXT. INTERRUPT 0 EDGE FLAG
0000             49   IT1    BIT   08AH  ;TCON.2 - EXT. INTERRUPT 1 TYPE
0000             50   IE1    BIT   08BH  ;TCON.3 - EXT. INTERRUPT 1 EDGE FLAG
0000             51   TR0    BIT   08CH  ;TCON.4 - TIMER 0 ON/OFF CONTROL
0000             52   TF0    BIT   08DH  ;TCON.5 - TIMER 0 OVERFLOW FLAG
0000             53   TR1    BIT   08EH  ;TCON.6 - TIMER 1 ON/OFF CONTROL
0000             54   TF1    BIT   08FH  ;TCON.7 - TIMER 1 OVERFLOW FLAG
0000             55   RI     BIT   098H  ;SCON.0 - RECEIVE INTERRUPT FLAG
0000             56   TI     BIT   099H  ;SCON.1 - TRANSMIT INTERRUPT FLAG
0000             57   RB8    BIT   09AH  ;SCON.2 - RECEIVE BIT 8
0000             58   TB8    BIT   09BH  ;SCON.3 - TRANSMIT BIT 8
0000             59   REN    BIT   09CH  ;SCON.4 - RECEIVE ENABLE
0000             60   SM2    BIT   09DH  ;SCON.5 - SERIAL MODE CONTROL BIT 2
0000             61   SM1    BIT   09EH  ;SCON.6 - SERIAL MODE CONTROL BIT 1
0000             62   SM0    BIT   09FH  ;SCON.7 - SERIAL MODE CONTROL BIT 0
0000             63   EX0    BIT   0A8H  ;IE.0 - EXTERNAL INTERRUPT 0 ENABLE
0000             64   ET0    BIT   0A9H  ;IE.1 - TIMER 0 INTERRUPT ENABLE
0000             65   EX1    BIT   0AAH  ;IE.2 - EXTERNAL INTERRUPT 1 ENABLE
0000             66   ET1    BIT   0ABH  ;IE.3 - TIMER 1 INTERRUPT ENABLE
0000             67   ES     BIT   0ACH  ;IE.4 - SERIAL PORT INTERRUPT ENABLE
0000             68   ET2    BIT   0ADH  ;IE.5 - TIMER 2 INTERRUPT ENABLE
0000             69   EA     BIT   0AFH  ;IE.7 - GLOBAL INTERRUPT ENABLE
0000             70   RXD    BIT   0B0H  ;P3.0 - SERIAL PORT RECEIVE INPUT
0000             71   TXD    BIT   0B1H  ;P3.1 - SERIAL PORT TRANSMIT OUTPUT
0000             72   INT0   BIT   0B2H  ;P3.2 - EXTERNAL INTERRUPT 0 INPUT
0000             73   INT1   BIT   0B3H  ;P3.3 - EXTERNAL INTERRUPT 1 INPUT
0000             74   T0     BIT   0B4H  ;P3.4 - TIMER 0 COUNT INPUT
0000             75   T1     BIT   0B5H  ;P3.5 - TIMER 1 COUNT INPUT
0000             76   WR     BIT   0B6H  ;P3.6 - WRITE CONTROL FOR EXT. MEMORY
0000             77   RD     BIT   0B7H  ;P3.7 - READ CONTROL FOR EXT. MEMORY
0000             78   PX0    BIT   0B8H  ;IP.0 - EXTERNAL INTERRUPT 0 PRIORITY
0000             79   PT0    BIT   0B9H  ;IP.1 - TIMER 0 PRIORITY
0000             80   PX1    BIT   0BAH  ;IP.2 - EXTERNAL INTERRUPT 1 PRIORITY
0000             81   PT1    BIT   0BBH  ;IP.3 - TIMER 1 PRIORITY
0000             82   PS     BIT   0BCH  ;IP.4 - SERIAL PORT PRIORITY
0000             83   PT2    BIT   0BDH  ;IP.5 - TIMER 2 PRIORITY
0000             84   CAP2   BIT   0C8H  ;T2CON.0 - CAPTURE OR RELOAD SELECT
0000             85   CNT2   BIT   0C9H  ;T2CON.1 - TIMER OR COUNTER SELECT
0000             86   TR2    BIT   0CAH  ;T2CON.2 - TIMER 2 ON/OFF CONTROL
0000             87   EXEN2  BIT   0CBH  ;T2CON.3 - TIMER 2 EXTERNAL ENABLE FLAG
0000             88   TCLK   BIT   0CCH  ;T2CON.4 - TRANSMIT CLOCK SELECT
0000             89   RCLK   BIT   0CDH  ;T2CON.5 - RECEIVE CLOCK SELECTT
0000             90   EXF2   BIT   0CEH  ;T2CON.6 - EXTERNAL TRANSITION FLAG
0000             91   TF2    BIT   0CFH  ;T2CON.7 - TIMER 2 OVERFLOW FLAG
0000             92   P      BIT   0D0H  ;PSW.0 - ACCUMULATOR PARITY FLAG
0000             93   OV     BIT   0D2H  ;PSW.2 - OVERFLOW FLAG
0000             94   RS0    BIT   0D3H  ;PSW.3 - REGISTER BANK SELECT 0
0000             95   RS1    BIT   0D4H  ;PSW.4 - REGISTER BANK SELECT 1
0000             96   F0     BIT   0D5H  ;PSW.5 - FLAG 0
0000             97   AC     BIT   0D6H  ;PSW.6 - AUXILIARY CARRY FLAG
0000             98   CY     BIT   0D7H  ;PSW.7 - CARRY FLAG
0000             99   
0000            100   ; For the altera DE2 configured with an 8051/8052 softcore processor
0000            101   ; we have the following extra registers:
0000            102   
0000            103   HEX0   DATA  091H ; Zero turns the segment on
0000            104   HEX1   DATA  092H ; 
0000            105   HEX2   DATA  093H ; 
0000            106   HEX3   DATA  094H ; 
0000            107   HEX4   DATA  08EH ;
0000            108   HEX5   DATA  08FH ;
0000            109   HEX6   DATA  096H ;
0000            110   HEX7   DATA  097H ;
0000            111   
0000            112   P0MOD  DATA  09AH ; Input/output mode bits for port 0.  '1' sets the port to output mode.
0000            113   P1MOD  DATA  09BH ; Input/output mode bits for port 1
0000            114   P2MOD  DATA  09CH ; Input/output mode bits for port 2
0000            115   P3MOD  DATA  09DH ; Input/output mode bits for port 3
0000            116   
0000            117   LEDRA  DATA  0E8H ; LEDs LEDR0 to LEDR7 (bit addressable, ex: LEDRA.1 for LEDR1)
0000            118   LEDRB  DATA  095H ; LEDs LEDR8 to LEDR15
0000            119   LEDRC  DATA  09EH ; LEDs LEDR16, LEDR15, and LEDG8
0000            120   LEDG   DATA  0F8H ; LEDs LEDG0 to LEDG7 (bit addressable, ex: LEDG.3 for LEDG3)
0000            121   SWA    DATA  0E8H ; Switches SW0 to SW7 (bit addressable, ex: SWA.1 for SW1)
0000            122   SWB    DATA  095H ; Switches SW8 to SW15
0000            123   SWC    DATA  09EH ; Switches SW16 and SW17
0000            124   KEY    DATA  0F8H ; KEY1=KEY.1, KEY2=KEY.2, KEY3=KEY.3.  KEY0 is the reset button! 
0000            125   
0000            126   LCD_CMD   DATA 0D8H ;
0000            127   LCD_DATA  DATA 0D9H ;
0000            128   LCD_MOD   DATA 0DAH ; Write 0xff to make LCD_DATA an output
0000            129   LCD_RW    BIT  0D8H ; '0' writes to LCD
0000            130   LCD_EN    BIT  0D9H ; Toggle from '1' to '0'
0000            131   LCD_RS    BIT  0DAH ; '0' for commands, '1' for data
0000            132   LCD_ON    BIT  0DBH ; Write '1' to power the LCD
0000            133   LCD_BLON  BIT  0DCH ; Write '1' to turn on back light
0000            134   
0000            135   FLASH_CMD  data 0DBH ; The control bits of the flash memory:
0000            136   ; bit 0: FL_RST_N  Set to 1 for normal operation
0000            137   ; bit 1: FL_WE_N
0000            138   ; bit 2: FL_OE_N
0000            139   ; bit 3: FL_CE_N
0000            140   FLASH_DATA data 0DCH ; 8-bit data bus of flash memory.
0000            141   FLASH_MOD  data 0DDH ; 0xff makes FLASH_DATA output.  0x00 makes FLASH_DATA input.
0000            142   FLASH_ADD0 data 0E1H ; address bits 0 to 7.
0000            143   FLASH_ADD1 data 0E2H ; address bits 8 to 15.
0000            144   FLASH_ADD2 data 0E3H ; address bits 16 to 21.
0000            145   
0000              6   
0000              7   CLK EQU 33333333
0000              8   FREQ_0 EQU 2000
0000              9   FREQ_2 EQU 100
0000             10   TIMER0_RELOAD EQU 65536-(CLK/(12*2*FREQ_0))
0000             11   TIMER2_RELOAD EQU 65536-(CLK/(12*FREQ_2))
0000             12   
0000             13   org 0000H
0000 020289      14            ljmp myprogram
0003             15            
000B             16   org 000BH
000B 020151      17            ljmp ISR_timer0
000E             18            
002B             19   org 002BH
002B 020038      20            ljmp ISR_timer2
002E             21   
0030             22   DSEG at 30H
0030             23   BCD_count: ds 3
0033             24   NewTime_count: ds 3
0036             25   AlarmCount: ds 3
0039             26   Cnt_10ms:  ds 1
003A             27   sec              : ds 2
003C             28   hours    : ds 2
003E             29   
0000             30   BSEG 
0000             31   Meridiem:        dbit 1
0001             32   MeridiemAlarm: dbit 1
0002             33   
0002             34   
002E             35   CSEG
002E             36   
002E             37   ; Look-up table for 7-segment displays
002E             38   myLUT:
002E C0F9A4B0    39       DB 0C0H, 0F9H, 0A4H, 0B0H, 099H
     99
0033 9282F880    40       DB 092H, 082H, 0F8H, 080H, 090H
     90
0038             41   
0038             42   ISR_timer2:
0038 C0D0        43            push psw
003A C0E0        44            push acc
003C C082        45            push dpl
003E C083        46            push dph
0040             47            
0040 C2CF        48            clr TF2
0042 B281        49            cpl P0.1
0044             50            
0044 E539        51            mov a, Cnt_10ms
0046 04          52            inc a
0047 F539        53            mov Cnt_10ms, a
0049             54            
0049 753300      55            mov NewTime_count+0,#0
004C 753400      56            mov NewTime_count+1,#0
004F 753512      57            mov NewTime_count+2,#12H
0052             58            
0052 B4644D      59            cjne a, #100, do_nothing1
0055             60            
0055             61   ;        mov a, AlarmCount+1     
0055             62   ;        mov 30H, BCD_count+1
0055             63   ;        cjne a, 30H, Continue
0055             64   ;        mov a, AlarmCount+2
0055             65   ;        mov 31H, BCD_count+2
0055             66   ;        cjne a, 31H, Continue   
0055             67   ;        mov a, meridiem
0055             68   ;        mov 32H, meridiemAlarm
0055             69   ;        cjne a, 32H, Continue
0055             70   ;        lcall SoundAlarm
0055             71            
0055 20E803      72            jb SWA.0, M1
0058 30E806      73            jnb SWA.0, Continue
005B             74            
005B 120266      75   M1: lcall ClearDisplay
005E 1201BC      76            lcall SetTime2
0061             77            
0061             78   Continue:
0061 753900      79            mov Cnt_10ms, #0
0064 E530        80            mov a, BCD_count+0
0066 2401        81            add a, #1
0068 D4          82            da a
0069 F530        83            mov BCD_count+0, a
006B B46037      84            cjne A, #60H, Display
006E             85            ;ljmp Min       
006E             86            
006E 753000      87   Min:mov BCD_count+0, #00H
0071 E531        88            mov a, BCD_count+1
0073 2401        89            add a, #1
0075 D4          90            da a
0076 F531        91            mov BCD_count+1, a
0078 B4602A      92            cjne A, #60H, Display
007B             93            ;ljmp Hour
007B             94            
007B             95   Hour:
007B 753100      96            mov BCD_count+1,#00H
007E E532        97            mov a, BCD_count+2
0080 2401        98            add a, #1
0082 D4          99            da a
0083 F532       100            mov BCD_count+2, a
0085 B41211     101            cjne A, #12H, M8
0088            102   CPLMeridiem:
0088 B200       103            cpl meridiem
008A 300003     104            jnb meridiem, AM
008D 200006     105            jb meridiem, PM
0090 759108     106   AM: mov HEX0, #08H
0093 0200A5     107            ljmp Display
0096 75910C     108   PM: mov HEX0, #0CH
0099 B41309     109   M8:      cjne A,#13H, Display
009C 753201     110            mov BCD_count+2, #1H
009F 0200A5     111            ljmp Display
00A2            112            
00A2            113   do_nothing1:
00A2 0200DB     114            ljmp do_nothing
00A5            115            
00A5            116   Display:
00A5 20EB33     117            jb SWA.3, do_nothing
00A8 30EB00     118            jnb SWA.3, cont2
00AB            119   cont2:
00AB 90002E     120            mov dptr, #myLUT
00AE            121   ; Display Digit 1
00AE E530       122            mov A, BCD_count+0
00B0 540F       123       anl A, #0FH
00B2 93         124       movc A, @A+dptr
00B3 F593       125       mov HEX2, A
00B5            126   ; Display Digit 2
00B5 E530       127       mov A, BCD_count+0
00B7 C4         128       swap A
00B8 540F       129       anl A, #0FH
00BA 93         130       movc A, @A+dptr
00BB F594       131       mov HEX3, A  
00BD            132   ; Display digit 3
00BD E531       133            mov A, BCD_count+1
00BF 540F       134            anl A, #0FH
00C1 93         135            movc A, @A+dptr
00C2 F58E       136            mov HEX4, A     
00C4            137   ;Display digit 4
00C4 E531       138            mov A, BCD_count+1
00C6 C4         139            swap A
00C7 540F       140            anl A, #0FH
00C9 93         141            movc A, @A+dptr
00CA F58F       142            mov HEX5, A
00CC            143   ;Display digit 5
00CC E532       144            mov A, BCD_count+2
00CE 540F       145            anl A, #0FH
00D0 93         146            movc A, @A+dptr
00D1 F596       147            mov HEX6, A
00D3            148   ;Display digit 6
00D3 E532       149            mov A, BCD_count+2
00D5 C4         150            swap A
00D6 540F       151            anl A, #0FH
00D8 93         152            movc A, @A+dptr
00D9 F597       153            mov HEX7, A
00DB            154            
00DB            155   do_nothing:
00DB D083       156            pop dph
00DD D082       157            pop dpl
00DF D0E0       158            pop acc
00E1 D0D0       159            pop psw         
00E3 32         160            reti
00E4            161   
00E4            162   SetAlarm2:
00E4 753600     163            mov AlarmCount+0, #0H
00E7 753700     164            mov AlarmCount+1, #0H
00EA 753812     165            mov AlarmCount+2, #12H
00ED 1200F1     166            lcall SetAlarm
00F0 22         167            ret
00F1            168            
00F1            169   SetAlarm:
00F1 20EC07     170            jb SWA.4, SetAlarmMin
00F4 20ED23     171            jb SWA.5, SetAlarmHour
00F7 20EBF7     172            jb SWA.3, SetAlarm
00FA 22         173            ret
00FB            174   
00FB            175   SetAlarmMin:
00FB 30EBF3     176            jnb SWA.3, SetAlarm
00FE 30ECFA     177            jnb SWA.4, SetAlarmMin
0101 E537       178            mov a, AlarmCount+1
0103 2401       179            add a, #1
0105 D4         180            da a
0106 B46004     181            cjne a, #60H, M9
0109 756E60     182            mov min, #60H
010C E4         183            clr a
010D F537       184   M9:      mov AlarmCount+1, a
010F 12018B     185            lcall DisplaySetTime2
0112 20EC00     186            jb SWA.4, WaitSW4
0115            187   WaitSW4:
0115 20ECFD     188            jb SWA.4, WaitSW4
0118 80D7       189            sjmp SetAlarm
011A            190   
011A            191   SetAlarmHour:
011A 30EBD4     192            jnb SWA.3, SetAlarm
011D 30EDFA     193            jnb SWA.5, SetAlarmHour
0120 E538       194            mov a, AlarmCount+2
0122 2401       195            add a, #1
0124 D4         196            da a
0125 B41303     197            cjne a, #13H, M14
0128 7401       198            mov a, #1H
012A D4         199            da a
012B F538       200   M14:mov AlarmCount+2, a
012D 12018B     201            lcall DisplaySetTime2
0130 12013B     202            lcall AMPM2
0133 20ED00     203            jb SWA.5, WaitSW5
0136            204   WaitSW5:
0136 20EDFD     205            jb SWA.5, WaitSW5
0139 80B6       206            sjmp SetAlarm
013B            207   
013B            208   AMPM2:
013B E538       209            mov a, AlarmCount+2
013D B41210     210            cjne a, #12H, return2
0140 B201       211            cpl MeridiemAlarm 
0142 300103     212            jnb MeridiemAlarm, ChangeToAM2
0145 200105     213            jb MeridiemAlarm, ChangeToPM2
0148            214   ChangeToAM2:
0148 759108     215            mov HEX0, #08H
014B 8003       216            sjmp return2
014D            217   ChangeToPM2:
014D 75910C     218            mov HEX0, #0CH
0150            219   return2:
0150 22         220            ret     
0151            221            
0151            222   ISR_timer0:
0151 20EB03     223            jb SWA.3, M11
0154 30EB09     224            jnb SWA.3, Cont
0157 75F801     225   M11:mov LEDG,#1H
015A 120266     226            lcall ClearDisplay
015D 1200E4     227            lcall SetAlarm2
0160            228   Cont:
0160            229   ;        lcall CheckAlarm
0160 B280       230            cpl P0.0
0162 758CFD     231   M15:mov TH0, #high(TIMER0_RELOAD)
0165 758A4A     232       mov TL0, #low(TIMER0_RELOAD)
0168 32         233            reti
0169            234    
0169            235   CheckAlarm:
0169 E537       236            mov a, AlarmCount+1     
016B 853130     237            mov 30H, BCD_count+1
016E B401F1     238            cjne a, #1H, M15
0171 E538       239            mov a, AlarmCount+2
0173 853231     240            mov 31H, BCD_count+2
0176 B412E9     241            cjne a, #12H, M15       
0179 E500       242            mov a, meridiem
017B 850132     243            mov 32H, meridiemAlarm
017E B532E1     244            cjne a, 32H, M15
0181 120185     245            lcall SoundAlarm
0184 22         246            ret
0185            247   
0185            248   SoundAlarm:
0185 D281       249            setb P0.1
0187 30EEFB     250            jnb SWA.6, SoundAlarm
018A 22         251            ret
018B            252    
018B            253   DisplaySetTime2:
018B 90002E     254            mov dptr, #myLUT        
018E            255   ; Display Digit 1
018E E536       256            mov A, AlarmCount+0
0190 540F       257       anl A, #0FH
0192 93         258       movc A, @A+dptr
0193 F593       259       mov HEX2, A   
0195            260   ; Display Digit 2
0195 E536       261       mov A, AlarmCount+0
0197 C4         262       swap A
0198 540F       263       anl A, #0FH
019A 93         264       movc A, @A+dptr
019B F594       265       mov HEX3, A   
019D            266   ; Display digit 3
019D E537       267            mov A, AlarmCount+1
019F 540F       268            anl A, #0FH
01A1 93         269            movc A, @A+dptr
01A2 F58E       270            mov HEX4, A     
01A4            271   ;Display digit 4
01A4 E537       272            mov A, AlarmCount+1
01A6 C4         273            swap A
01A7 540F       274            anl A, #0FH
01A9 93         275            movc A, @A+dptr
01AA F58F       276            mov HEX5, A     
01AC            277   ;Display digit 5
01AC E538       278            mov A, AlarmCount+2
01AE 540F       279            anl A, #0FH
01B0 93         280            movc A, @A+dptr
01B1 F596       281            mov HEX6, A
01B3            282   ;Display digit 6
01B3 E538       283            mov A, AlarmCount+2
01B5 C4         284            swap A
01B6 540F       285            anl A, #0FH
01B8 93         286            movc A, @A+dptr
01B9 F597       287            mov HEX7, A
01BB 22         288            ret
01BC            289   
01BC            290    
01BC            291   SetTime2:
01BC 753300     292            mov NewTime_count+0,#0
01BF 753400     293            mov NewTime_count+1,#0
01C2 753512     294            mov NewTime_count+2,#12H
01C5 C200       295            clr meridiem
01C7 1201CB     296            lcall SetTime
01CA 22         297            ret
01CB            298    
01CB            299   SetTime:
01CB 20E90A     300            jb SWA.1, SetTimeMin
01CE 20EA23     301            jb SWA.2, SetTimeHour
01D1 20E8F7     302            jb SWA.0, SetTime
01D4 12022B     303            lcall MoveToBCD                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
01D7 22         304            ret
01D8            305   
01D8            306   SetTimeMin:
01D8 30E8F0     307            jnb SWA.0, SetTime
01DB 30E9FA     308            jnb SWA.1, SetTimeMin
01DE E534       309            mov a, NewTime_count+1
01E0 2401       310            add a, #1
01E2 D4         311            da a
01E3 B46001     312            cjne a, #60H, M5
01E6 E4         313            clr a
01E7 F534       314   M5:      mov NewTime_count+1, a
01E9 120235     315            lcall DisplaySetTime
01EC 20E900     316            jb SWA.1, WaitSW1
01EF            317   WaitSW1:
01EF 20E9FD     318            jb SWA.1, WaitSW1
01F2 80D7       319            sjmp SetTime
01F4            320            
01F4            321   SetTimeHour:
01F4 30E8D4     322            jnb SWA.0, SetTime
01F7 30EAFA     323            jnb SWA.2, SetTimeHour
01FA E535       324            mov a, NewTime_count+2
01FC 2401       325            add a, #1
01FE D4         326            da a
01FF B41303     327            cjne a, #13H, M7
0202 7401       328   M6:      mov a, #1H
0204 D4         329            da a
0205 F535       330   M7:      mov NewTime_count+2, a
0207 120235     331            lcall DisplaySetTime
020A 120215     332            lcall AMPM
020D 20EA00     333            jb SWA.2, WaitSW2
0210            334   WaitSW2:
0210 20EAFD     335            jb SWA.2, WaitSW2
0213 80B6       336            sjmp SetTime
0215            337   
0215            338   AMPM:
0215 E535       339            mov a, NewTime_count+2
0217 B41210     340            cjne a, #12H, return
021A B200       341            cpl meridiem 
021C 300003     342            jnb meridiem, ChangeToAM
021F 200005     343            jb meridiem, ChangeToPM
0222            344   ChangeToAM:
0222 759108     345            mov HEX0, #08H
0225 8003       346            sjmp return
0227            347   ChangeToPM:
0227 75910C     348            mov HEX0, #0CH
022A            349   return:
022A 22         350            ret     
022B            351   
022B            352   MoveToBCD:
022B 853330     353            mov BCD_count+0, NewTime_count+0
022E 853431     354            mov BCD_count+1, NewTime_count+1
0231 853532     355            mov BCD_count+2, NewTime_count+2
0234 22         356            ret
0235            357            
0235            358            
0235            359   DisplaySetTime:
0235 90002E     360            mov dptr, #myLUT
0238            361            
0238            362   ; Display Digit 1
0238 E533       363            mov A, NewTime_count+0
023A 540F       364       anl A, #0FH
023C 93         365       movc A, @A+dptr
023D F593       366       mov HEX2, A
023F            367       
023F            368   ; Display Digit 2
023F E533       369       mov A, NewTime_count+0
0241 C4         370       swap A
0242 540F       371       anl A, #0FH
0244 93         372       movc A, @A+dptr
0245 F594       373       mov HEX3, A  
0247            374       
0247            375   ; Display digit 3
0247 E534       376            mov A, NewTime_count+1
0249 540F       377            anl A, #0FH
024B 93         378            movc A, @A+dptr
024C F58E       379            mov HEX4, A
024E            380            
024E            381   ;Display digit 4
024E E534       382            mov A, NewTime_count+1
0250 C4         383            swap A
0251 540F       384            anl A, #0FH
0253 93         385            movc A, @A+dptr
0254 F58F       386            mov HEX5, A
0256            387            
0256            388   ;Display digit 5
0256 E535       389            mov A, NewTime_count+2
0258 540F       390            anl A, #0FH
025A 93         391            movc A, @A+dptr
025B F596       392            mov HEX6, A
025D            393   
025D            394   ;Display digit 6
025D E535       395            mov A, NewTime_count+2
025F C4         396            swap A
0260 540F       397            anl A, #0FH
0262 93         398            movc A, @A+dptr
0263 F597       399            mov HEX7, A
0265 22         400            ret
0266            401   
0266            402   ClearDisplay:
0266 759108     403            mov HEX0, #08H
0269 759340     404       mov HEX2, #40H
026C 759440     405       mov HEX3, #40H
026F 758E40     406       mov HEX4, #40H
0272 758F40     407       mov HEX5, #40H
0275 7596A4     408       mov HEX6, #0A4H
0278 7597F9     409       mov HEX7, #0F9H
027B 22         410       ret
027C            411       
027C            412   ;For a 33.33MHz clock, one cycle takes 30ns
027C            413   WaitHalfSec:
027C 7A5A       414            mov R2, #90
027E 79FA       415   L3: mov R1, #250
0280 78FA       416   L2: mov R0, #250
0282 D8FE       417   L1: djnz R0, L1
0284 D9FA       418            djnz R1, L2
0286 DAF6       419            djnz R2, L3
0288 22         420            ret
0289            421            
0289            422   myprogram:
0289 75817F     423            mov SP, #7FH
028C 75E800     424            mov LEDRA,#0
028F 759500     425            mov LEDRB,#0
0292 759E00     426            mov LEDRC,#0
0295 75F800     427            mov LEDG,#0
0298 759A03     428            mov P0MOD, #00000011B ; P0.0, P0.1 are outputs.  P0.1 is used for testing Timer 2!
029B D280       429            setb P0.0
029D            430   
029D 758901     431       mov TMOD,  #00000001B ; GATE=0, C/T*=0, M1=0, M0=1: 16-bit timer
02A0 C28C       432            clr TR0 ; Disable timer 0
02A2 C28D       433            clr TF0
02A4 758CFD     434       mov TH0, #high(TIMER0_RELOAD)
02A7 758A4A     435       mov TL0, #low(TIMER0_RELOAD)
02AA D28C       436       setb TR0 ; Enable timer 0
02AC D2A9       437       setb ET0 ; Enable timer 0 interrupt
02AE            438       
02AE            439           
02AE 75C800     440       mov T2CON, #00H ; Autoreload is enabled, work as a timer
02B1 C2CA       441       clr TR2
02B3 C2CF       442       clr TF2
02B5            443       ; Set up timer 2 to interrupt every 10ms
02B5 75CB93     444       mov RCAP2H,#high(TIMER2_RELOAD)
02B8 75CA7F     445       mov RCAP2L,#low(TIMER2_RELOAD)
02BB D2CA       446       setb TR2
02BD D2AD       447       setb ET2
02BF 759108     448       mov HEX0, #08H
02C2 120266     449       lcall ClearDisplay
02C5            450       
02C5 7412       451       mov a, #12H
02C7 D4         452       da a
02C8            453       
02C8 753000     454       mov BCD_count+0, #0
02CB 753100     455       mov BCD_count+1, #0
02CE F532       456       mov BCD_count+2, a
02D0            457       
02D0 753600     458       mov AlarmCount+0, #0
02D3 753700     459       mov AlarmCount+1, #0
02D6 F538       460       mov AlarmCount+2, a
02D8            461       
02D8 C200       462       clr meridiem
02DA C201       463       clr MeridiemAlarm
02DC 753900     464       mov Cnt_10ms, #0
02DF            465       
02DF 753A3C     466       mov sec, #60
02E2 753C0C     467       mov hours, #12
02E5            468        
02E5 D2AF       469       setb EA  ; Enable all interrupts
02E7            470   
02E7            471   M0:
02E7 B2E8       472            cpl LEDRA.0
02E9 12027C     473            lcall WaitHalfSec
02EC 80F9       474            sjmp M0
02EE            475   EN
